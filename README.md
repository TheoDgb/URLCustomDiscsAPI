# URLCustomDiscsAPI
**API** for the **URLCustomDiscs** plugin, allowing **Minecraft servers** to register via a unique token and dynamically generate custom resource packs based on user-submitted URLs.\
The **API** uses **yt-dlp** and **FFmpeg** to download and convert audio files, which are then added as custom audio discs (which can also be removed) to a dedicated resource pack hosted on Cloudflare R2.\
This enables **Minecraft servers** to serve up-to-date custom discs in real time, allowing players to automatically receive new audio content without restarting or reinstalling anything.

## URLCustomDiscs Plugin
The **URLCustomDiscs.jar** plugin is available for download in the [**Releases**](https://github.com/TheoDgb/URLCustomDiscs/releases) section of the [URLCustomDiscs GitHub repository](https://github.com/TheoDgb/URLCustomDiscs).\
It is also available on [Modrinth](https://modrinth.com/plugin/url-custom-discs) ([**Versions**](https://modrinth.com/plugin/url-custom-discs/versions)).

## Dependencies
### License & Attribution
This **API** uses the following external tools:
- **yt-dlp** from the [yt-dlp GitHub repository](https://github.com/yt-dlp/yt-dlp) under the [Unlicense](https://github.com/yt-dlp/yt-dlp/blob/master/LICENSE)
- **FFmpeg** from the [FFmpeg Static Builds](https://johnvansickle.com/ffmpeg/) under the [GNU General Public License version 3 (GPLv3)](https://www.gnu.org/licenses/gpl-3.0.html)
### Tool Usage
- **yt-dlp** is used to download MP3 audio files from YouTube URLs.
- **FFmpeg** is used to convert MP3 files to Ogg format.

## Features
- Register **Minecraft servers** and manage resource packs.
- Dynamically add and remove custom audio discs.
- Support for external tools **yt-dlp** and **FFmpeg** for audio downloading and conversion.
- Automatic updates of **yt-dlp**.
- Storage and hosting of resource packs via Cloudflare R2.
- Maximum allowed resource pack size and custom discs per pack are both limited by the **API** to 80 MB and 10 custom discs respectively.
- Active tokens limiting: only 2 **Minecraft servers** can process custom disc creation or deletion requests concurrently to reduce **API** memory usage and avoid overload.
- Rate limiting and request queuing per **Minecraft server** token: to maintain **API** stability, each token is limited to 6 requests per minute and requests are processed sequentially.
- Automatic cleanup of inactive tokens and resource packs after 3 months of inactivity.

## Token Authentication
Every request to the **API** must include a token that uniquely identifies a registered **Minecraft server**.
- Purpose: The token ensures that each **Minecraft server** has isolated access to its own resource pack and data.
- Usage: The token must be included in the JSON body of the request.
- Generated by: A unique token is generated and assigned when a **Minecraft server** registers for the first time by creating a custom disc.
- Required for:
  - Identifying the **Minecraft server** and its associated resource pack.
  - Uploading or removing custom discs in the resource pack.
  - Enforcing active tokens concurrency limit for creation and deletion requests.
  - Applying rate limiting and managing request queues per token.
  - Tracking **Minecraft servers** activity to enable automatic cleanup of unused tokens and resource packs.

## Rate Limiting
To prevent request spamming, the **API** enforces rate limiting per token:
- Maximum 6 requests per minute per token.
- If this limit is exceeded, the **API** doesn't add the request to the request queue.

## Active Tokens
To reduce memory usage, the **API** allows a maximum of 2 active tokens (**Minecraft servers**) at the same time for custom disc creation and deletion requests.
- Only 2 different server tokens can have pending requests being processed concurrently.
- If more than 2 tokens send requests simultaneously, excess requests are ignored until one of the active tokens finishes.

This prevents overload from too many concurrent audio conversions and resource pack updates.

## Request Queue
To avoid conflicts when modifying resource packs, the **API** processes requests sequentially per token using a request queue:
- Requests for the same token are enqueued and processed in order.

This ensures resource pack consistency and prevents race conditions.

## Inactive Token Cleanup
To keep the API and storage clean, the system automatically removes inactive Minecraft server tokens and their corresponding resource pack from Cloudflare R2 if unused for over 3 months.
- Activity includes: disc creation or deletion using the token.
- If no activity is detected on a token after 90 days, the following cleanup occurs:
  - The token is unregistered from the system.
  - The Minecraft server’s resource pack is deleted from Cloudflare R2.
- This cleanup runs automatically every Monday at 3:00 AM (America / New York timezone) using a scheduled cron job.

This ensures that storage and server-side resources are used efficiently, and that inactive **Minecraft servers** don’t retain unnecessary data indefinitely.

## API Response & Error Handling
The **API** returns clear JSON responses indicating success or failure for each request.\
Errors such as rate limit exceeded, invalid tokens, or internal server issues are properly handled and communicated with appropriate HTTP status codes and messages.

## Installation & Setup
Create a Cloudflare R2 bucket and Account API Token.
Create your own .env with .env.example, then:
```
npm init -y
npm install express cors body-parser uuid @aws-sdk/client-s3 dotenv tar lzma-native extract-zip adm-zip node-cron
npm start
```

## Commands Used
```
npm init -y
npm install express cors body-parser
npm install uuid

SDK AWS S3
npm install @aws-sdk/client-s3

npm install dotenv
npm install tar
npm install lzma-native
npm install extract-zip
npm install adm-zip
npm install node-cron

sudo npm start

node scripts/setupBinaries.js
node scripts/cleanupInactiveTokens.js
```
